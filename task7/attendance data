import json
import os
from datetime import datetime

# The file where data will be stored permanently
DATA_FILE = "attendance_data.json"

def load_data():
    """Loads the attendance dictionary from the JSON file."""
    if not os.path.exists(DATA_FILE):
        return {}  # Return empty dict if file doesn't exist yet
    try:
        with open(DATA_FILE, 'r') as file:
            return json.load(file)
    except (json.JSONDecodeError, IOError):
        return {}

def save_data(data):
    """Saves the attendance dictionary to the JSON file."""
    try:
        with open(DATA_FILE, 'w') as file:
            json.dump(data, file, indent=4)
        print(">> Data saved successfully.")
    except IOError as e:
        print(f"Error saving data: {e}")

def mark_attendance(data):
    """Function to mark attendance for a specific date."""
    print("\n--- Mark Attendance ---")
    
    # Get Date (Default to today or custom)
    date_input = input("Enter Date (YYYY-MM-DD) or press Enter for Today: ").strip()
    if not date_input:
        date_input = datetime.now().strftime("%Y-%m-%d")
    
    # Initialize date key if not present
    if date_input not in data:
        data[date_input] = {}

    print(f"Marking attendance for: {date_input}")
    print("Type 'done' to stop adding students.")

    while True:
        name = input("Enter Student Name: ").strip()
        if name.lower() == 'done':
            break
        
        status = input(f"Is {name} Present (P) or Absent (A)? ").upper()
        if status in ['P', 'PRESENT']:
            final_status = "Present"
        elif status in ['A', 'ABSENT']:
            final_status = "Absent"
        else:
            print("Invalid status. Defaulting to Absent.")
            final_status = "Absent"

        # Update the nested dictionary
        data[date_input][name] = final_status

    save_data(data)

def view_attendance(data):
    """Function to view attendance for a specific date."""
    print("\n--- View Attendance Report ---")
    date_input = input("Enter Date to view (YYYY-MM-DD): ").strip()

    if date_input in data:
        records = data[date_input]
        print(f"\nAttendance for {date_input}:")
        print("-" * 30)
        print(f"{'Name':<20} | {'Status'}")
        print("-" * 30)
        
        present_count = 0
        for name, status in records.items():
            print(f"{name:<20} | {status}")
            if status == "Present":
                present_count += 1
        
        print("-" * 30)
        print(f"Total Present: {present_count} / {len(records)}")
    else:
        print(f"No records found for date: {date_input}")

def main():
    """Main menu loop."""
    attendance_data = load_data()

    while True:
        print("\n=== DATE-WISE ATTENDANCE SYSTEM ===")
        print("1. Mark Attendance")
        print("2. View Attendance Report")
        print("3. Exit")
        
        choice = input("Enter choice (1-3): ")

        if choice == '1':
            mark_attendance(attendance_data)
        elif choice == '2':
            view_attendance(attendance_data)
        elif choice == '3':
            print("Exiting system. Goodbye!")
            break
        else:
            print("Invalid choice, please try again.")

if __name__ == "__main__":
    main()